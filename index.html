<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>E55 Mix Optimizer</title>
  <link rel="manifest" href="manifest.json">
  
<style>
input[type=range] {
  -webkit-appearance: none;
  width: 100%;
  height: 8px;
  background: #ccc;
  border-radius: 5px;
  outline: none;
  transition: background 0.3s;
  position: relative;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: #fff;
  border: 2px solid #4caf50;
  cursor: pointer;
  margin-top: -8px;
}
input[type=range]::-moz-range-thumb {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: #fff;
  border: 2px solid #4caf50;
  cursor: pointer;
}
.range-container {
  position: relative;
  margin-bottom: 24px;
}
.slider-value {
  position: absolute;
  top: -32px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 14px;
  color: #fff;
  background: #4caf50;
  padding: 2px 8px;
  border-radius: 12px;
  white-space: nowrap;
  display: none;
}
</style>

<style>
/* Prevent iOS input zoom */
input, select, textarea {
  font-size: 16px;
}

/* Fix slider green backfill */
input[type=range] {
  -webkit-appearance: none;
  width: 100%;
  height: 8px;
  background: #ccc;
  border-radius: 5px;
  outline: none;
  transition: background 0.3s;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: #fff;
  border: 2px solid #4caf50;
  cursor: pointer;
  margin-top: -7px;
}
input[type=range]::-moz-range-thumb {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: #fff;
  border: 2px solid #4caf50;
  cursor: pointer;
}
/* For green fill as range is dragged */
input[type=range]::-webkit-slider-runnable-track {
  background: linear-gradient(to right, #4caf50 0%, #4caf50 var(--val, 50%), #ccc var(--val, 50%), #ccc 100%);
  height: 8px;
  border-radius: 5px;
}
</style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #111;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background-color: #1e1e1e;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
      width: 90%;
      max-width: 500px;
    }
    h1 {
      color: #57f287;
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin: 20px 0 5px;
    }
    .slider-container {
      position: relative;
      width: 100%;
    }
    input[type="range"] {
      width: 100%;
      appearance: none;
      height: 8px;
      background: #333;
      border-radius: 5px;
      outline: none;
      transition: background 0.3s;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid #57f287;
      cursor: pointer;
      margin-top: -8px;
      box-shadow: 0 0 2px rgba(0,0,0,0.5);
    }
    .value-label {
      font-size: 0.9rem;
      color: #ccc;
      margin-top: 5px;
      text-align: right;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      margin-top: 15px;
      cursor: pointer;
    }
    .calculate {
      background-color: #007bff;
      color: white;
    }
    .reset {
      background-color: #333;
      color: white;
    }
    .result {
      margin-top: 20px;
      background-color: #2c2c2c;
      padding: 15px;
      border-radius: 10px;
      color: #bfffc5;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Target: E55 Mix Optimizer</h1>

    <label>Current Fuel Level (% of 15.6 gal):</label>
    <div class="slider-container">
      <input type="range" id="fuelLevel" min="0" max="100" value="50" oninput="updateValue(this)" />
      <div class="value-label" id="fuelLevelVal">50%</div>
    </div>

    <label>Current Ethanol % (from flex sensor):</label>
    <div class="slider-container">
      <input type="range" id="ethanolCurrent" min="0" max="100" value="50" oninput="updateValue(this)" />
      <div class="value-label" id="ethanolCurrentVal">50%</div>
    </div>

    <label>Target Fuel Level (% of 15.6 gal):</label>
    <div class="slider-container">
      <input type="range" id="fuelTarget" min="0" max="100" value="90" oninput="updateValue(this)" />
      <div class="value-label" id="fuelTargetVal">90%</div>
    </div>

    <label>Actual E85 % (measured at pump):</label>
    <div class="slider-container">
      <input type="range" id="ethanolE85" min="70" max="100" value="85" oninput="updateValue(this)" />
      <div class="value-label" id="ethanolE85Val">85%</div>
    </div>

    <button class="calculate" onclick="calculate()">Calculate</button>
    <button class="reset" onclick="resetForm()">Reset</button>

    <div class="result" id="resultBox" style="display:none;"></div>
  </div>

  <script>
    function updateValue(input) {
      document.getElementById(input.id + 'Val').textContent = input.value + '%';
    }

    function calculate() {
      const tankSize = 15.6;
      const curLevel = parseFloat(document.getElementById('fuelLevel').value) / 100 * tankSize;
      const curE = parseFloat(document.getElementById('ethanolCurrent').value);
      const tgtLevel = parseFloat(document.getElementById('fuelTarget').value) / 100 * tankSize;
      const e85 = parseFloat(document.getElementById('ethanolE85').value);
      const tgtE = 55;

      let bestMatch = null;
      for (let e85Add = 0; e85Add <= (tgtLevel - curLevel); e85Add += 0.01) {
        let totalVol = curLevel + e85Add;
        let eContent = (curLevel * curE + e85Add * e85) / totalVol;
        let needed93 = tgtLevel - totalVol;
        let finalVol = totalVol + needed93;
        eContent = (curLevel * curE + e85Add * e85 + needed93 * 10) / finalVol;
        if (Math.abs(eContent - tgtE) < 0.2) {
          bestMatch = { e85Add, needed93, finalVol, eContent };
          break;
        }
      }

      let resultBox = document.getElementById('resultBox');
      if (bestMatch) {
        const e85L = (bestMatch.e85Add * 3.785).toFixed(1);
        const r93L = (bestMatch.needed93 * 3.785).toFixed(1);
        const volPct = ((bestMatch.finalVol / tankSize) * 100).toFixed(1);
        resultBox.innerHTML = `
          ✅ <strong>Optimized Blend (Target: E55)</strong><br>
          ➤ Add E85: ${e85L} L (${bestMatch.e85Add.toFixed(2)} gal)<br>
          ➤ Add 93 Octane: ${r93L} L (${bestMatch.needed93.toFixed(2)} gal)<br>
          ➤ Final Ethanol: ${bestMatch.eContent.toFixed(2)}%<br>
          ➤ Final Volume: ${bestMatch.finalVol.toFixed(2)} gal (${volPct}% of tank)
        `;
      } else {
        resultBox.innerHTML = `⚠️ Could not reach E55. Try increasing your E85 volume or reducing target fill.`;
      }
      resultBox.style.display = 'block';
    }

    function resetForm() {
      ['fuelLevel','ethanolCurrent','fuelTarget','ethanolE85'].forEach(id => {
        let input = document.getElementById(id);
        input.value = id === 'fuelTarget' ? 90 : 50;
        updateValue(input);
      });
      document.getElementById('ethanolE85').value = 85;
      updateValue(document.getElementById('ethanolE85'));
      document.getElementById('resultBox').style.display = 'none';
    }
  </script>

<script>
document.querySelectorAll('.range-container input[type=range]').forEach(slider => {
  const valueBubble = slider.parentElement.querySelector('.slider-value');

  function updateSliderBackground(slider) {
    const val = (slider.value - slider.min) / (slider.max - slider.min) * 100;
    slider.style.background = `linear-gradient(to right, #4caf50 0%, #4caf50 ${val}%, #ccc ${val}%, #ccc 100%)`;
  }

  slider.addEventListener('input', () => {
    valueBubble.style.display = 'block';
    valueBubble.textContent = `${slider.value}%`;
    updateSliderBackground(slider);
  });

  slider.addEventListener('change', () => {
    valueBubble.style.display = 'block';
    valueBubble.textContent = `${slider.value}%`;
  });

  slider.addEventListener('touchend', () => {
    setTimeout(() => valueBubble.style.display = 'block', 100);
  });

  updateSliderBackground(slider);
});
</script>
</body>
</html>