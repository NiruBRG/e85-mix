
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="manifest" href="manifest.json"/>
  <title>E55 Mix Optimizer</title>
  <style>
    body {
      background-color: #121212;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .container {
      background-color: #1e1e1e;
      border-radius: 15px;
      padding: 20px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    h1 {
      font-size: 22px;
      color: #55FF99;
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
    }
    .slider-container {
      position: relative;
      width: 100%;
    }
    .slider {
      width: 100%;
      appearance: none;
      height: 8px;
      background: #333;
      border-radius: 5px;
      outline: none;
      margin-bottom: 5px;
    }
    .slider::-webkit-slider-thumb {
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #00FF99;
      border: 3px solid white;
      cursor: pointer;
    }
    .slider-fill {
      position: absolute;
      top: 50%;
      height: 8px;
      background: #00FF99;
      border-radius: 5px;
      transform: translateY(-50%);
      z-index: 0;
    }
    .bubble {
      position: absolute;
      background: #333;
      padding: 2px 8px;
      border-radius: 12px;
      color: white;
      font-size: 12px;
      transform: translate(-50%, -150%);
      display: none;
    }
    button {
      width: 100%;
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      color: white;
      font-size: 16px;
      background-color: #007bff;
      cursor: pointer;
    }
    button:active {
      background-color: #0056b3;
    }
    .output {
      background-color: #2c2c2c;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      font-size: 14px;
    }
    .output .good {
      color: #00FF99;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Target: E55 Mix Optimizer</h1>

    <label>Current Fuel Level (% of 15.6 gal):</label>
    <div class="slider-container">
      <div class="slider-fill" id="fill1"></div>
      <input type="range" min="0" max="100" value="50" class="slider" id="slider1">
      <div class="bubble" id="bubble1">50%</div>
    </div>

    <label>Current Ethanol % (from flex sensor):</label>
    <div class="slider-container">
      <div class="slider-fill" id="fill2"></div>
      <input type="range" min="0" max="100" value="50" class="slider" id="slider2">
      <div class="bubble" id="bubble2">50%</div>
    </div>

    <label>Target Fuel Level (% of 15.6 gal):</label>
    <div class="slider-container">
      <div class="slider-fill" id="fill3"></div>
      <input type="range" min="0" max="100" value="100" class="slider" id="slider3">
      <div class="bubble" id="bubble3">100%</div>
    </div>

    <label>Actual E85 % (measured at pump):</label>
    <div class="slider-container">
      <div class="slider-fill" id="fill4"></div>
      <input type="range" min="70" max="90" value="85" class="slider" id="slider4">
      <div class="bubble" id="bubble4">85%</div>
    </div>

    <button onclick="calculate()">Calculate</button>
    <button onclick="location.reload()">Reset</button>

    <div class="output" id="outputBox"></div>
  </div>

  <script>
    const sliders = [1, 2, 3, 4];
    sliders.forEach(n => {
      const slider = document.getElementById(`slider${n}`);
      const fill = document.getElementById(`fill${n}`);
      const bubble = document.getElementById(`bubble${n}`);
      const updateSlider = () => {
        const value = parseInt(slider.value);
        const percent = value / (slider.max - slider.min) * 100;
        fill.style.width = percent + "%";
        bubble.innerText = value + "%";
        bubble.style.left = percent + "%";
      };
      slider.addEventListener('input', () => {
        updateSlider();
        bubble.style.display = 'block';
      });
      slider.addEventListener('change', () => {
        bubble.style.display = 'none';
      });
      updateSlider();
    });

    function calculate() {
      const currentFuel = parseFloat(slider1.value) / 100 * 15.6;
      const currentEthanol = parseFloat(slider2.value);
      const targetFuel = parseFloat(slider3.value) / 100 * 15.6;
      const actualE85 = parseFloat(slider4.value);

      const currentEthanolAmount = (currentEthanol / 100) * currentFuel;
      const targetEthanolAmount = 0.55 * targetFuel;

      let found = false;
      let best = null;

      for (let e85 = 0; e85 <= (targetFuel - currentFuel); e85 += 0.01) {
        let fuel93 = (targetFuel - currentFuel) - e85;
        let finalEthanol = (currentEthanolAmount + e85 * (actualE85 / 100)) / targetFuel * 100;

        if (Math.abs(finalEthanol - 55) <= 0.3) {
          best = { e85, fuel93, finalEthanol };
          found = true;
          break;
        }
      }

      const output = document.getElementById("outputBox");
      if (found) {
        output.innerHTML = `
          <div class="good">✅ Optimized Blend (Target: E55)</div>
          ➤ Add E85: ${ (best.e85 * 3.785).toFixed(1) } L (${best.e85.toFixed(2)} gal)<br>
          ➤ Add 93 Octane: ${(best.fuel93 * 3.785).toFixed(1)} L (${best.fuel93.toFixed(2)} gal)<br>
          ➤ Final Ethanol: ${best.finalEthanol.toFixed(2)}%<br>
          ➤ Final Volume: ${targetFuel.toFixed(2)} gal (${((targetFuel / 15.6) * 100).toFixed(1)}% of tank)
        `;
      } else {
        let possible = ((currentEthanolAmount / targetFuel) * 100).toFixed(2);
        output.innerHTML = `
          <div class="good">⚠️ E55 Not Reachable</div>
          ➤ Closest possible ethanol %: ${possible}%<br>
          ➤ Final Volume: ${targetFuel.toFixed(2)} gal (${((targetFuel / 15.6) * 100).toFixed(1)}% of tank)
        `;
      }
    }
  </script>
</body>
</html>
